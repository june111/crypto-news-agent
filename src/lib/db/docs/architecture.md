# 数据库模块架构

本文档提供了数据库模块的整体架构和组件之间的关系说明。

## 架构概览

```
                           +-------------+
                           | 应用层组件  |
                           +------+------+
                                  |
                                  | 导入和使用
                                  |
                         +--------v--------+
                         |   db/index.ts   |
                         | (模块入口点)    |
                         +--------+--------+
                                  |
                                  | 导出
                                  |
           +--------------------------------------------+
           |                      |                     |
+----------v---------+  +---------v---------+  +-------v-------+
| getSupabaseClient  |  | initDatabaseOnce  |  | repositories  |
+----------+---------+  +---------+---------+  +-------+-------+
           |                      |                     |
           v                      v                     v
+----------+---------+  +---------+---------+  +-------+-------+
|  connection-pool   |  |    supabase.ts    |  | 各种仓库实现  |
+--------------------+  +---------+---------+  +---------------+
                                  |
                        +---------v---------+
                        |     schema.ts     |
                        +---------+---------+
                                  |
                                  v
                        +---------+---------+
                        |    utils/logger   |
                        +-------------------+
```

## 模块组件关系

### 核心组件

1. **index.ts** - 模块入口点
   - 导出 `getSupabaseClient`：获取数据库客户端
   - 导出 `initDatabaseOnce`：初始化数据库（按需延迟加载）
   - 导出所有仓库

2. **connection-pool.ts** - 连接池管理
   - 使用React cache API实现单例模式
   - 提供健康检查功能
   - 管理连接重试和请求ID

3. **supabase.ts** - Supabase客户端实现
   - 实现真实数据库客户端
   - 实现模拟(mock)客户端
   - 提供数据库初始化函数

4. **schema.ts** - 数据结构定义
   - 定义数据库模型接口
   - 定义表名常量

### 数据访问层

1. **repositories/** - 数据仓库目录
   - **index.ts** - 聚合所有仓库并导出
   - **articleRepository.ts** - 文章操作
   - **aiTaskRepository.ts** - AI任务操作
   - **templatesRepository.ts** - 模板操作
   - **hotTopicsRepository.ts** - 热点话题操作
   - **embeddingsRepository.ts** - 向量嵌入操作

### 辅助组件

1. **utils/logger.ts** - 日志工具
   - 提供不同级别日志记录功能
   - 根据环境变量控制日志输出

2. **migrations/** - 数据库迁移脚本
   - 提供SQL脚本创建数据库表和索引

3. **tests/** - 测试套件
   - 提供各个模块的单元测试

## 数据流

1. **应用初始化流程**:
   ```
   应用启动
     ↓
   调用 initDatabaseOnce()
     ↓
   导入 supabase.initDatabase (按需加载)
     ↓
   检查数据库表是否存在
     ↓
   设置初始化标志
   ```

2. **数据操作流程**:
   ```
   应用组件
     ↓
   调用仓库API (例如 articles.createArticle())
     ↓
   仓库获取数据库客户端 (getSupabaseClient)
     ↓
   执行数据库操作并错误处理
     ↓
   返回结果
   ```

3. **Mock模式流程**:
   ```
   应用组件
     ↓
   调用仓库API
     ↓
   getSupabaseClient() 检测MOCK_MODE标志
     ↓
   返回模拟客户端 (in-memory数据存储)
     ↓
   执行模拟操作
   ```

## 数据库模型关系

```
+-----------+       +----------+       +------------+
|  Article  <-------+  AITask  |       |  Template  |
+-----------+       +----------+       +------------+
    ^                                         ^
    |                                         |
    |     +------------+     +------------+   |
    +-----+ Embedding  |     |  HotTopic  +---+
          +------------+     +------------+
```

## 技术选择

1. **React cache API**: 在Next.js环境中实现真正的单例模式，确保每个请求周期只创建一个连接实例

2. **仓库模式**: 将数据访问逻辑与业务逻辑分离，提供清晰的API界面

3. **按需加载**: 使用动态导入，减少初始加载体积

4. **模拟模式**: 支持离线开发和测试，无需真实数据库连接 