# Dify回调API说明

## 功能概述

Dify回调API是用于接收Dify生成的内容并自动保存到Supabase文章表的接口。当Dify工作流生成内容后，会自动将内容发送到我们的回调接口，然后接口会将这些内容转换为文章格式并保存到数据库中。

## 接口说明

### 回调接口

- 路径: `/api/dify/callback`
- 方法: `POST`
- 功能: 接收Dify生成的内容，将其保存到文章表中

接口接收的数据格式示例:

```json
{
  "content": "文章正文内容...",
  "describe": "文章摘要...",
  "title": "文章标题",
  "image": [
    {
      "url": "图片URL"
    }
  ],
  "date": "2025-04-03 16:03:27"
}
```

处理流程:
1. 接收Dify回调数据
2. 验证必要的内容和标题字段
3. 处理图片链接
4. 从标题中提取关键词
5. 构建文章数据
6. 保存到Supabase文章表
7. 返回保存结果

### 测试接口

- 路径: `/api/dify/callback/test`
- 方法: `GET`
- 功能: 测试回调接口功能，发送模拟数据到回调接口

测试接口会发送一组预设的测试数据到回调接口，并返回处理结果，用于验证回调功能是否正常。

## 配置说明

Dify工作流运行时会自动设置回调URL，无需额外配置。在`/api/dify/workflow/run`接口中，我们自动构建了回调URL并添加到请求参数中。

## 使用方法

### 自动回调

1. 在前端通过`DifyClient.runWorkflow`方法运行工作流
2. 工作流完成后，Dify会自动调用我们的回调接口
3. 回调接口将生成的内容保存到文章表
4. 用户可以在文章列表中看到新生成的文章

### 手动测试

访问`/api/dify/callback/test`接口可以手动触发测试，该接口会发送模拟数据到回调接口，并返回处理结果。

## 数据处理

- **标题**: 直接使用Dify返回的`title`字段
- **内容**: 直接使用Dify返回的`content`字段
- **摘要**: 使用Dify返回的`describe`字段，如果没有则截取内容的前200个字符
- **封面图**: 使用Dify返回的`image[0].url`字段，如果没有则使用默认图片
- **关键词**: 从标题中提取可能的关键词
- **分类**: 默认为"区块链"
- **状态**: 默认为"待审核"

## 注意事项

1. 确保Supabase配置正确，包括URL和服务密钥
2. 图片URL可能会过期，应考虑将其下载并存储到自己的存储中
3. 为确保安全，可以考虑添加验证机制，仅接受来自Dify的回调请求
4. 在生产环境中应添加异常处理和重试机制 